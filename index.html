<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema CRUD - Gestión de Rutas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: none;
        }
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .currency {
            text-align: right;
        }
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        @media (max-width: 768px) {
            .header-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-route me-2"></i>Sistema de Gestión de Rutas</h1>
                    <div class="header-actions">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#routeModal" onclick="openModal()">
                            <i class="fas fa-plus"></i> Nueva Ruta
                        </button>
                        <button class="btn btn-info" onclick="exportToCSV()">
                            <i class="fas fa-download"></i> Exportar CSV
                        </button>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
                        <button class="btn btn-warning" onclick="document.getElementById('csvFileInput').click()">
                            <i class="fas fa-upload"></i> Importar CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros y búsqueda -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="searchInput" class="form-label">Buscar</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Buscar por ruta, agencia o zona..." onkeyup="filterTable()">
                            </div>
                            <div class="col-md-3">
                                <label for="agencyFilter" class="form-label">Filtrar por Agencia</label>
                                <select class="form-select" id="agencyFilter" onchange="filterTable()">
                                    <option value="">Todas las agencias</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="zoneFilter" class="form-label">Filtrar por Zona</label>
                                <select class="form-select" id="zoneFilter" onchange="filterTable()">
                                    <option value="">Todas las zonas</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de rutas -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Lista de Rutas <span id="recordCount" class="badge bg-secondary">0</span></h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Índice</th>
                                        <th>Ruta</th>
                                        <th>Agencia</th>
                                        <th>Zona</th>
                                        <th>Descripción</th>
                                        <th class="currency">Flete (Bs.)</th>
                                        <th width="150">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="routeTableBody">
                                    <!-- Los datos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear/editar ruta -->
    <div class="modal fade" id="routeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Nueva Ruta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="routeForm">
                        <input type="hidden" id="routeIndex">
                        
                        <div class="mb-3">
                            <label for="ruta" class="form-label">Ruta *</label>
                            <input type="text" class="form-control" id="ruta" required>
                            <div class="invalid-feedback">Por favor ingresa la ruta.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="agencia" class="form-label">Agencia *</label>
                            <input type="text" class="form-control" id="agencia" required>
                            <div class="invalid-feedback">Por favor ingresa la agencia.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="zona" class="form-label">Zona *</label>
                            <input type="text" class="form-control" id="zona" required>
                            <div class="invalid-feedback">Por favor ingresa la zona.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion" rows="3" placeholder="Descripción opcional de la ruta"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="flete" class="form-label">Flete (Bs.) *</label>
                            <input type="number" class="form-control" id="flete" step="0.01" min="0" required>
                            <div class="invalid-feedback">Por favor ingresa un flete válido.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveRoute()" id="saveButton">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que deseas eliminar esta ruta?</p>
                    <p class="text-muted mb-0" id="deleteRouteInfo"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()" id="confirmDeleteButton">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let routes = [];
        let editingIndex = -1;
        let deleteIndex = -1;

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            loadRoutes();
            loadSampleData();
            updateTable();
            updateFilters();
        });

        // Cargar datos desde localStorage
        function loadRoutes() {
            const savedRoutes = localStorage.getItem('routes');
            if (savedRoutes) {
                routes = JSON.parse(savedRoutes);
            }
        }

        // Guardar datos en localStorage
        function saveRoutes() {
            localStorage.setItem('routes', JSON.stringify(routes));
        }

        // Cargar datos de ejemplo si no hay datos
        function loadSampleData() {
            if (routes.length === 0) {
                routes = [
                    {
                        indice: 1,
                        ruta: "La Paz - Cochabamba",
                        agencia: "Trans Copacabana",
                        zona: "Altiplano",
                        descripcion: "Ruta directa entre La Paz y Cochabamba via carretera principal",
                        flete: 25.50
                    },
                    {
                        indice: 2,
                        ruta: "La Paz - Santa Cruz",
                        agencia: "Bolivar",
                        zona: "Nacional",
                        descripcion: "Conexión principal La Paz - Santa Cruz",
                        flete: 45.00
                    },
                    {
                        indice: 3,
                        ruta: "Cochabamba - Sucre",
                        agencia: "Trans Copacabana",
                        zona: "Valle",
                        descripcion: "Ruta valle a valle",
                        flete: 30.75
                    },
                    {
                        indice: 4,
                        ruta: "La Paz - Oruro",
                        agencia: "6 de Octubre",
                        zona: "Altiplano",
                        descripcion: "Ruta corta altiplano",
                        flete: 15.00
                    }
                ];
                saveRoutes();
            }
        }

        // Actualizar tabla
        function updateTable() {
            const tbody = document.getElementById('routeTableBody');
            tbody.innerHTML = '';

            const filteredRoutes = getFilteredRoutes();
            
            filteredRoutes.forEach(route => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="badge bg-primary">${route.indice}</span></td>
                    <td><strong>${route.ruta}</strong></td>
                    <td>${route.agencia}</td>
                    <td><span class="badge bg-info">${route.zona}</span></td>
                    <td>${route.descripcion || '<em class="text-muted">Sin descripción</em>'}</td>
                    <td class="currency"><strong>Bs. ${parseFloat(route.flete).toFixed(2)}</strong></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-action me-1" onclick="editRoute(${route.indice})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteRoute(${route.indice})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Actualizar contador
            document.getElementById('recordCount').textContent = filteredRoutes.length;
        }

        // Obtener rutas filtradas
        function getFilteredRoutes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const agencyFilter = document.getElementById('agencyFilter').value;
            const zoneFilter = document.getElementById('zoneFilter').value;

            return routes.filter(route => {
                const matchesSearch = !searchTerm || 
                    route.ruta.toLowerCase().includes(searchTerm) ||
                    route.agencia.toLowerCase().includes(searchTerm) ||
                    route.zona.toLowerCase().includes(searchTerm) ||
                    (route.descripcion && route.descripcion.toLowerCase().includes(searchTerm));

                const matchesAgency = !agencyFilter || route.agencia === agencyFilter;
                const matchesZone = !zoneFilter || route.zona === zoneFilter;

                return matchesSearch && matchesAgency && matchesZone;
            });
        }

        // Actualizar filtros
        function updateFilters() {
            const agencies = [...new Set(routes.map(route => route.agencia))].sort();
            const zones = [...new Set(routes.map(route => route.zona))].sort();

            const agencySelect = document.getElementById('agencyFilter');
            const zoneSelect = document.getElementById('zoneFilter');

            // Limpiar opciones existentes (excepto la primera)
            agencySelect.innerHTML = '<option value="">Todas las agencias</option>';
            zoneSelect.innerHTML = '<option value="">Todas las zonas</option>';

            // Agregar opciones de agencias
            agencies.forEach(agency => {
                const option = document.createElement('option');
                option.value = agency;
                option.textContent = agency;
                agencySelect.appendChild(option);
            });

            // Agregar opciones de zonas
            zones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone;
                option.textContent = zone;
                zoneSelect.appendChild(option);
            });
        }

        // Filtrar tabla
        function filterTable() {
            updateTable();
        }

        // Limpiar filtros
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('agencyFilter').value = '';
            document.getElementById('zoneFilter').value = '';
            updateTable();
        }

        // Abrir modal para nueva ruta o edición
        function openModal(index = null) {
            editingIndex = index;
            const modal = document.getElementById('routeModal');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('routeForm');
            const saveButton = document.getElementById('saveButton');

            // Limpiar validación anterior
            form.classList.remove('was-validated');

            if (index !== null) {
                // Modo edición
                const route = routes.find(r => r.indice === index);
                modalTitle.textContent = 'Editar Ruta';
                saveButton.textContent = 'Actualizar';
                
                document.getElementById('routeIndex').value = route.indice;
                document.getElementById('ruta').value = route.ruta;
                document.getElementById('agencia').value = route.agencia;
                document.getElementById('zona').value = route.zona;
                document.getElementById('descripcion').value = route.descripcion || '';
                document.getElementById('flete').value = route.flete;
            } else {
                // Modo creación
                modalTitle.textContent = 'Nueva Ruta';
                saveButton.textContent = 'Guardar';
                form.reset();
                document.getElementById('routeIndex').value = '';
            }
        }

        // Editar ruta
        function editRoute(index) {
            openModal(index);
        }

        // Guardar ruta (crear o actualizar)
        function saveRoute() {
            const form = document.getElementById('routeForm');
            
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const routeData = {
                ruta: document.getElementById('ruta').value.trim(),
                agencia: document.getElementById('agencia').value.trim(),
                zona: document.getElementById('zona').value.trim(),
                descripcion: document.getElementById('descripcion').value.trim(),
                flete: parseFloat(document.getElementById('flete').value)
            };

            if (editingIndex !== null) {
                // Actualizar ruta existente
                const routeIndex = routes.findIndex(r => r.indice === editingIndex);
                routes[routeIndex] = { ...routes[routeIndex], ...routeData };
            } else {
                // Crear nueva ruta
                const newIndex = routes.length > 0 ? Math.max(...routes.map(r => r.indice)) + 1 : 1;
                routes.push({ indice: newIndex, ...routeData });
            }

            saveRoutes();
            updateTable();
            updateFilters();

            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('routeModal'));
            modal.hide();

            // Mostrar mensaje de éxito
            showAlert(editingIndex !== null ? 'Ruta actualizada correctamente' : 'Ruta creada correctamente', 'success');
        }

        // Eliminar ruta
        function deleteRoute(index) {
            deleteIndex = index;
            const route = routes.find(r => r.indice === index);
            document.getElementById('deleteRouteInfo').textContent = `${route.ruta} - ${route.agencia}`;
            
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }

        // Confirmar eliminación
        function confirmDelete() {
            routes = routes.filter(route => route.indice !== deleteIndex);
            saveRoutes();
            updateTable();
            updateFilters();

            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();

            showAlert('Ruta eliminada correctamente', 'warning');
        }

        // Exportar a CSV
        function exportToCSV() {
            if (routes.length === 0) {
                showAlert('No hay datos para exportar', 'warning');
                return;
            }

            const headers = ['Indice', 'Ruta', 'Agencia', 'Zona', 'Descripcion', 'Flete'];
            const csvContent = [
                headers.join(','),
                ...routes.map(route => [
                    route.indice,
                    `"${route.ruta}"`,
                    `"${route.agencia}"`,
                    `"${route.zona}"`,
                    `"${route.descripcion || ''}"`,
                    route.flete
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `rutas_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('Archivo CSV exportado correctamente', 'success');
        }

        // Importar desde CSV
        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        showAlert('El archivo CSV debe tener al menos una fila de datos', 'error');
                        return;
                    }

                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    const newRoutes = [];

                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                        
                        if (values.length >= 6) {
                            newRoutes.push({
                                indice: parseInt(values[0]) || (routes.length + newRoutes.length + 1),
                                ruta: values[1] || '',
                                agencia: values[2] || '',
                                zona: values[3] || '',
                                descripcion: values[4] || '',
                                flete: parseFloat(values[5]) || 0
                            });
                        }
                    }

                    if (newRoutes.length > 0) {
                        // Confirmar importación
                        if (confirm(`¿Deseas importar ${newRoutes.length} rutas? Esto agregará las rutas a las existentes.`)) {
                            routes = [...routes, ...newRoutes];
                            saveRoutes();
                            updateTable();
                            updateFilters();
                            showAlert(`${newRoutes.length} rutas importadas correctamente`, 'success');
                        }
                    } else {
                        showAlert('No se encontraron datos válidos en el archivo CSV', 'error');
                    }
                } catch (error) {
                    showAlert('Error al procesar el archivo CSV', 'error');
                }
            };
            reader.readAsText(file);
            
            // Limpiar input
            event.target.value = '';
        }

        // Mostrar alertas
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remover después de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
